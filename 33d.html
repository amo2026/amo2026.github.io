<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>福彩3D交集计算系统 · 形态筛选</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* === 全局样式（紧凑优化）=== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: #333;
            line-height: 1.4;
            padding: 10px 8px;
            min-height: 100vh;
            font-size: 13px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 12px;
            padding: 12px 10px;
            background: linear-gradient(to right, #2c3e50, #4a6491);
            color: white;
            border-radius: 8px;
            box-shadow: 0 3px 8px rgba(44, 62, 80, 0.15);
        }

        h1 {
            font-size: 1.3rem;
            margin-bottom: 4px;
            letter-spacing: 0.3px;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
            margin-bottom: 12px;
        }

        .section-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 4px;
            border-bottom: 1px solid #e1e8ed;
            padding-bottom: 6px;
        }

        .section-title i {
            color: #4a90e2;
        }

        /* 条件输入框 */
        .textarea-container {
            position: relative;
            margin-bottom: 8px;
        }

        textarea {
            width: 100%;
            height: 70px;
            padding: 8px;
            border: 1.5px solid #e1e8ed;
            border-radius: 6px;
            font-size: 13px;
            resize: vertical;
            transition: border-color 0.2s;
            line-height: 1.3;
            -webkit-user-select: text;
            user-select: text;
        }

        textarea:focus {
            outline: none;
            border-color: #4a90e2;
        }

        .textarea-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.85rem;
        }

        .input-count {
            position: absolute;
            top: 8px;
            right: 10px;
            font-size: 0.7rem;
            color: #7f8c8d;
            background: rgba(255, 255, 255, 0.9);
            padding: 1px 5px;
            border-radius: 6px;
            z-index: 2;
        }

        /* 按钮 */
        .btn {
            padding: 10px 12px;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            width: 100%;
            margin-bottom: 6px;
            touch-action: manipulation;
        }

        .btn-sm {
            padding: 5px 8px;
            font-size: 0.75rem;
            width: auto;
            margin: 0;
        }

        .btn-outline {
            background: transparent;
            color: #4a90e2;
            border: 1.5px solid #4a90e2;
        }

        .btn-outline:active {
            background: #4a90e2;
            color: white;
            transform: translateY(1px);
        }

        .btn-success {
            background: linear-gradient(to right, #2ecc71, #27ae60);
            color: white;
        }

        .btn-success:active {
            background: linear-gradient(to right, #27ae60, #219653);
            transform: translateY(1px);
        }

        .btn-danger {
            background: linear-gradient(to right, #e74c3c, #c0392b);
            color: white;
        }

        .button-row {
            display: flex;
            gap: 6px;
        }

        .button-row .btn {
            flex: 1;
            margin-bottom: 0;
        }

        /* ===== 条件选项卡片（优化间距） ===== */
        .condition-option-group {
            background: #f0f7fa;
            border-radius: 8px;
            padding: 12px;
            margin-top: 15px;        /* 与上方按钮拉开距离 */
            margin-bottom: 15px;
            border: 1px solid #d9e6f2;
        }

        .option-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-bottom: 12px;
        }

        .radio-label, .checkbox-label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85rem;
            color: #333;
        }

        .checkbox-group {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }

        /* ===== 定位筛选（图标美化） ===== */
        .position-filter-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        .position-filter-header i {
            width: 24px;
            height: 24px;
            background: #e1f0ff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #4a90e2;
            font-size: 0.8rem;
        }

        .compact-position-selector {
            margin: 10px 0;
            padding: 10px;
            background: #f8fafc;
            border-radius: 6px;
            border: 1px solid #eef2f7;
        }

        .position-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .position-header h4 {
            font-size: 0.85rem;
            color: #2c3e50;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .single-line-numbers {
            display: flex;
            justify-content: space-between;
            gap: 4px;
            overflow-x: auto;
            padding: 4px 0;
            scrollbar-width: none;
        }
        .single-line-numbers::-webkit-scrollbar { display: none; }

        .number-btn-small {
            flex: 0 0 26px;
            height: 26px;
            border: none;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8fafc;
            color: #4a90e2;
            border: 1px solid #e1e8ed;
            touch-action: manipulation;
        }

        .number-btn-small.selected {
            background: linear-gradient(to bottom right, #4a90e2, #357ae8);
            color: white;
            border-color: #357ae8;
        }

        .number-btn-small.kill-selected {
            background: linear-gradient(to bottom right, #e74c3c, #c0392b);
            color: white;
            border-color: #c0392b;
        }

        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 4px;
        }

        .badge-blue {
            background-color: #e1f0ff;
            color: #4a90e2;
        }

        .badge-red {
            background-color: #fdeaea;
            color: #e74c3c;
        }

        /* ===== 结果区域（紧凑优化） ===== */
        .results-container {
            margin-top: 15px;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding: 6px 10px;
            background: #f0f7ff;
            border-radius: 6px;
        }

        .results-count, .results-price {
            font-size: 0.85rem;
            font-weight: 600;
        }

        .results-count span {
            color: #4a90e2;
            font-size: 0.95rem;
        }
        .results-price span {
            color: #27ae60;
            font-size: 0.95rem;
        }

        .results-display {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 8px;
            min-height: 80px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px dashed #ced4da;
            font-family: 'Consolas', 'Monaco', monospace;
            line-height: 1.5;
            white-space: pre-wrap;
            font-size: 12px;
            word-break: break-all;
            -webkit-user-select: text;
            user-select: text;
        }

        /* 等待提示居中 */
        .results-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            min-height: 60px;
            color: #7f8c8d;
            font-size: 0.85rem;
        }

        .number-item {
            display: inline-block;
            margin: 1px 2px;
            padding: 3px 6px;
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            font-size: 12px;
        }

        .number-item.selected {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }

        .number-item .delete-btn {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 16px;
            height: 16px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            cursor: pointer;
        }

        .number-item.selected .delete-btn {
            display: flex;
        }

        .remove-input-btn {
            position: absolute;
            bottom: 8px;
            right: 10px;
            background: #fee;
            color: #c0392b;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            padding: 3px 6px;
            font-size: 0.7rem;
            cursor: pointer;
        }

        .footer {
            text-align: center;
            margin-top: 15px;
            padding-top: 12px;
            border-top: 1px solid #e1e8ed;
            color: #7f8c8d;
            font-size: 0.75rem;
        }

        @media (max-width: 360px) {
            body { font-size: 12px; }
            .number-btn-small { flex: 0 0 24px; height: 24px; font-size: 0.75rem; }
            .number-item { padding: 2px 5px; font-size: 11px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-calculator"></i> 福彩3D交集计算系统</h1>
        </header>

        <!-- 主卡片 -->
        <div class="card">
            <div class="section-title"><i class="fas fa-code-branch"></i> 号码交集计算</div>
            
            <!-- 手动条件输入框（默认清空） -->
            <div class="textarea-container">
                <label class="textarea-label">条件 1 (3D号码，空格分隔):</label>
                <textarea id="input1" placeholder="322 352 235 253 532 523 327"></textarea>
                <div class="input-count">号码数: <span id="count1">0</span></div>
            </div>
            <div class="textarea-container">
                <label class="textarea-label">条件 2 (3D号码，空格分隔):</label>
                <textarea id="input2" placeholder="315 352 235 253 532 523 377"></textarea>
                <div class="input-count">号码数: <span id="count2">0</span></div>
            </div>
            <div id="intersection-inputs"></div>
            
            <div class="button-row">
                <button class="btn btn-outline" id="add-input"><i class="fas fa-plus"></i> 添加条件</button>
                <button class="btn btn-outline" id="clear-inputs"><i class="fas fa-broom"></i> 清空条件</button>
            </div>

            <!-- ========= 条件选项（始终启用）========= -->
            <div class="condition-option-group">
                <div class="option-title"><i class="fas fa-sliders-h"></i> 条件选项</div>
                
                <div class="radio-group">
                    <label class="radio-label">
                        <input type="radio" name="generateType" value="direct" checked> 生成所有直选
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="generateType" value="group"> 生成所有组选
                    </label>
                </div>
                
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="includeG3" checked> 包含组三
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="includeG6" checked> 包含组六
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="includeBZ" checked> 包含豹子
                    </label>
                </div>
                <!-- 已删除启用开关，生成条件始终参与计算 -->
            </div>

            <!-- ========= 定位筛选（图标美化）========= -->
            <div style="margin-top:5px;">
                <div class="position-filter-header">
                    <i class="fas fa-bullseye"></i>
                    <span style="font-weight:600; color:#2c3e50;">定位筛选</span>
                </div>
                
                <!-- 百位 -->
                <div class="compact-position-selector">
                    <div class="position-header">
                        <h4>百位 <span class="badge badge-blue">选号</span><span class="badge badge-red">杀号</span></h4>
                        <button class="btn btn-outline btn-sm clear-position" data-position="hundred">清空</button>
                    </div>
                    <div class="single-line-numbers" id="hundred"></div>
                    <div style="display:flex; justify-content:space-between; font-size:0.65rem; color:#888; margin-top:2px;">
                        <span>点击选号</span><span>长按杀号</span>
                    </div>
                </div>
                <!-- 十位 -->
                <div class="compact-position-selector">
                    <div class="position-header">
                        <h4>十位 <span class="badge badge-blue">选号</span><span class="badge badge-red">杀号</span></h4>
                        <button class="btn btn-outline btn-sm clear-position" data-position="ten">清空</button>
                    </div>
                    <div class="single-line-numbers" id="ten"></div>
                </div>
                <!-- 个位 -->
                <div class="compact-position-selector">
                    <div class="position-header">
                        <h4>个位 <span class="badge badge-blue">选号</span><span class="badge badge-red">杀号</span></h4>
                        <button class="btn btn-outline btn-sm clear-position" data-position="unit">清空</button>
                    </div>
                    <div class="single-line-numbers" id="unit"></div>
                </div>
                <!-- 清空所有定位条件 -->
                <div style="display:flex; justify-content:center; margin-top:10px;">
                    <label style="display:flex; align-items:center; gap:6px; font-size:0.8rem;">
                        <input type="checkbox" id="clear-all-conditions"> 清空所有定位条件
                    </label>
                </div>
            </div>

            <!-- 计算按钮 -->
            <div style="margin-top:15px;">
                <button class="btn btn-success" id="calculate-intersection">
                    <i class="fas fa-calculator"></i> 计算交集
                </button>
            </div>

            <!-- 结果显示区 -->
            <div class="results-container">
                <div class="results-header">
                    <div class="results-count">共 <span id="result-count">0</span> 注</div>
                    <div class="results-price">总价: <span id="result-price">0</span> 元 (2元/注)</div>
                </div>
                <div style="font-size:0.75rem; color:#666; margin-bottom:5px;">
                    <i class="fas fa-info-circle"></i> 点击号码可选中，点击右上角×可删除
                </div>
                <div class="results-display" id="intersection-results">
                    <div class="results-placeholder">等待计算结果...</div>
                </div>
                <div class="button-row" style="margin-top:10px;">
                    <button class="btn btn-outline" id="copy-results"><i class="fas fa-copy"></i> 复制结果</button>
                    <button class="btn btn-outline" id="export-results"><i class="fas fa-download"></i> 导出文件</button>
                    <button class="btn btn-danger" id="delete-selected"><i class="fas fa-trash"></i> 删除选中</button>
                </div>
            </div>
        </div>

        <!-- 使用说明卡片 -->
        <div class="card">
            <div class="section-title"><i class="fas fa-info-circle"></i> 使用说明</div>
            <div style="font-size:0.8rem; line-height:1.5; color:#333;">
                <p>1. 在条件框中粘贴3D号码（空格分隔），可添加多个条件框计算交集。</p>
                <p>2. <strong>条件选项</strong>：始终生效，根据“生成类型”和“包含形态”自动生成一组号码，作为条件0参与交集计算。</p>
                <p>3. 点击数字选号（蓝），长按数字杀号（红），可单独清空每位置。</p>
                <p>4. 计算结果按百位0-9排序，每行7注，可选中删除或批量删除。</p>
                <p>5. 复制结果或导出为文本文件。</p>
            </div>
            <div class="footer">
                <p>© 2025 福彩3D交集计算系统 | 仅供数据分析参考</p>
            </div>
        </div>
    </div>

    <script>
        // ---------- 全局变量 ----------
        let currentResults = [];

        // ---------- 初始化数字选择器（定位筛选）----------
        function initNumberSelectors() {
            const positions = ['hundred', 'ten', 'unit'];
            positions.forEach(pos => {
                const container = document.getElementById(pos);
                if (!container) return;
                container.innerHTML = '';
                for (let i = 0; i <= 9; i++) {
                    const btn = document.createElement('button');
                    btn.className = 'number-btn-small';
                    btn.textContent = i;
                    btn.dataset.number = i;
                    let timer, isLongPress = false;
                    btn.addEventListener('contextmenu', e => e.preventDefault());
                    btn.addEventListener('click', function(e) {
                        if (!isLongPress) {
                            if (this.classList.contains('kill-selected')) {
                                this.classList.remove('kill-selected');
                            } else if (this.classList.contains('selected')) {
                                this.classList.remove('selected');
                            } else {
                                this.classList.add('selected');
                            }
                        }
                        isLongPress = false;
                    });
                    const startLongPress = function(e) {
                        timer = setTimeout(() => {
                            isLongPress = true;
                            if (this.classList.contains('selected')) {
                                this.classList.remove('selected');
                            } else if (this.classList.contains('kill-selected')) {
                                this.classList.remove('kill-selected');
                            } else {
                                this.classList.add('kill-selected');
                            }
                        }, 500);
                    }.bind(btn);
                    btn.addEventListener('touchstart', startLongPress);
                    btn.addEventListener('touchend', () => clearTimeout(timer));
                    btn.addEventListener('touchmove', () => clearTimeout(timer));
                    btn.addEventListener('mousedown', startLongPress);
                    btn.addEventListener('mouseup', () => clearTimeout(timer));
                    btn.addEventListener('mouseleave', () => clearTimeout(timer));
                    container.appendChild(btn);
                }
            });
            // 清空单个位置
            document.querySelectorAll('.clear-position').forEach(btn => {
                btn.addEventListener('click', function() {
                    const pos = this.dataset.position;
                    document.querySelectorAll(`#${pos} .number-btn-small`).forEach(b => {
                        b.classList.remove('selected', 'kill-selected');
                    });
                });
            });
            // 清空所有定位条件
            document.getElementById('clear-all-conditions')?.addEventListener('change', function() {
                if (this.checked) {
                    document.querySelectorAll('.single-line-numbers .number-btn-small').forEach(b => {
                        b.classList.remove('selected', 'kill-selected');
                    });
                    this.checked = false;
                }
            });
        }

        // ---------- 条件框计数 ----------
        function initInputCounters() {
            ['input1', 'input2'].forEach(id => {
                const input = document.getElementById(id);
                const span = document.getElementById(`count${id.slice(-1)}`);
                const update = () => {
                    const nums = input.value.trim() ? input.value.trim().split(/\s+/).filter(n => n.length===3) : [];
                    span.textContent = nums.length;
                };
                input.addEventListener('input', update);
                update();
            });
        }

        // ---------- 添加条件框 ----------
        document.getElementById('add-input').addEventListener('click', function() {
            const container = document.getElementById('intersection-inputs');
            const idx = document.querySelectorAll('.textarea-container').length + 1;
            const div = document.createElement('div');
            div.className = 'textarea-container';
            div.innerHTML = `
                <label class="textarea-label">条件 ${idx} (3D号码，空格分隔):</label>
                <textarea id="input${idx}" placeholder="粘贴3D号码，用空格分隔..."></textarea>
                <div class="input-count">号码数: <span id="count${idx}">0</span></div>
                <button class="remove-input-btn" data-remove-input="${idx}"><i class="fas fa-times"></i> 删除</button>
            `;
            container.appendChild(div);
            const input = document.getElementById(`input${idx}`);
            const span = document.getElementById(`count${idx}`);
            input.addEventListener('input', function() {
                const nums = this.value.trim() ? this.value.trim().split(/\s+/).filter(n => n.length===3) : [];
                span.textContent = nums.length;
            });
            div.querySelector(`[data-remove-input="${idx}"]`).addEventListener('click', function() {
                if (document.querySelectorAll('.textarea-container').length > 2) {
                    div.remove();
                    document.querySelectorAll('.textarea-container').forEach((c, i) => {
                        const inp = c.querySelector('textarea');
                        const lbl = c.querySelector('.textarea-label');
                        const cnt = c.querySelector('.input-count span');
                        const del = c.querySelector('[data-remove-input]');
                        const newId = i + 1;
                        inp.id = `input${newId}`;
                        lbl.textContent = `条件 ${newId} (3D号码，空格分隔):`;
                        cnt.id = `count${newId}`;
                        if (del) del.dataset.removeInput = newId;
                    });
                } else alert('至少保留两个条件框');
            });
        });

        // ---------- 清空所有条件框 ----------
        document.getElementById('clear-inputs').addEventListener('click', function() {
            if (confirm('确定清空所有条件框？')) {
                document.querySelectorAll('textarea[id^="input"]').forEach(inp => {
                    inp.value = '';
                    const id = inp.id.slice(-1);
                    const span = document.getElementById(`count${id}`);
                    if (span) span.textContent = '0';
                });
            }
        });

        // ---------- 生成条件池（始终启用）----------
        function generateConditionPool() {
            const isDirect = document.querySelector('input[name="generateType"]:checked').value === 'direct';
            const includeG3 = document.getElementById('includeG3').checked;
            const includeG6 = document.getElementById('includeG6').checked;
            const includeBZ = document.getElementById('includeBZ').checked;
            
            if (!includeG3 && !includeG6 && !includeBZ) return [];

            const pool = new Set();

            if (isDirect) {
                for (let i = 0; i <= 999; i++) {
                    const num = i.toString().padStart(3, '0');
                    if (isMatch(num, includeG3, includeG6, includeBZ)) pool.add(num);
                }
            } else {
                // 组选 → 展开为直选
                if (includeBZ) {
                    for (let i = 0; i <= 9; i++) pool.add(i.toString().repeat(3));
                }
                if (includeG3) {
                    for (let a = 0; a <= 9; a++) {
                        for (let b = 0; b <= 9; b++) {
                            if (a === b) continue;
                            pool.add(`${a}${a}${b}`);
                            pool.add(`${a}${b}${a}`);
                            pool.add(`${b}${a}${a}`);
                        }
                    }
                }
                if (includeG6) {
                    for (let a = 0; a <= 9; a++) {
                        for (let b = a+1; b <= 9; b++) {
                            for (let c = b+1; c <= 9; c++) {
                                const arr = [a,b,c];
                                const perms = [[0,1,2],[0,2,1],[1,0,2],[1,2,0],[2,0,1],[2,1,0]];
                                perms.forEach(p => pool.add(`${arr[p[0]]}${arr[p[1]]}${arr[p[2]]}`));
                            }
                        }
                    }
                }
            }
            return Array.from(pool);
        }

        function isMatch(num, g3, g6, bz) {
            const d1=num[0], d2=num[1], d3=num[2];
            if (d1===d2 && d2===d3) return bz;
            if (d1===d2 || d2===d3 || d1===d3) return g3;
            return g6;
        }

        // ---------- 获取定位筛选条件 ----------
        function getPositionConditions() {
            const cond = { hundredSelect:[], tenSelect:[], unitSelect:[], hundredKill:[], tenKill:[], unitKill:[] };
            ['hundred','ten','unit'].forEach(pos => {
                document.querySelectorAll(`#${pos} .number-btn-small`).forEach(btn => {
                    if (btn.classList.contains('selected')) {
                        if (pos==='hundred') cond.hundredSelect.push(btn.dataset.number);
                        else if (pos==='ten') cond.tenSelect.push(btn.dataset.number);
                        else cond.unitSelect.push(btn.dataset.number);
                    } else if (btn.classList.contains('kill-selected')) {
                        if (pos==='hundred') cond.hundredKill.push(btn.dataset.number);
                        else if (pos==='ten') cond.tenKill.push(btn.dataset.number);
                        else cond.unitKill.push(btn.dataset.number);
                    }
                });
            });
            return cond;
        }

        // ---------- 应用定位筛选 ----------
        function applyPositionFilter(numbers, cond) {
            return numbers.filter(num => {
                const h=num[0], t=num[1], u=num[2];
                if (cond.hundredSelect.length && !cond.hundredSelect.includes(h)) return false;
                if (cond.tenSelect.length && !cond.tenSelect.includes(t)) return false;
                if (cond.unitSelect.length && !cond.unitSelect.includes(u)) return false;
                if (cond.hundredKill.length && cond.hundredKill.includes(h)) return false;
                if (cond.tenKill.length && cond.tenKill.includes(t)) return false;
                if (cond.unitKill.length && cond.unitKill.includes(u)) return false;
                return true;
            });
        }

        // ---------- 按百位排序 ----------
        function sortByHundred(arr) {
            return arr.sort((a,b) => a[0].localeCompare(b[0]));
        }

        // ---------- 渲染结果 ----------
        function renderResults(nums) {
            const container = document.getElementById('intersection-results');
            container.innerHTML = '';
            if (nums.length === 0) {
                const placeholder = document.createElement('div');
                placeholder.className = 'results-placeholder';
                placeholder.textContent = '没有找到符合条件的号码';
                container.appendChild(placeholder);
                return;
            }
            const sorted = sortByHundred(nums);
            sorted.forEach((num, idx) => {
                const span = document.createElement('span');
                span.className = 'number-item';
                span.textContent = num;
                span.dataset.number = num;
                const del = document.createElement('span');
                del.className = 'delete-btn';
                del.innerHTML = '×';
                span.appendChild(del);
                span.addEventListener('click', function(e) {
                    if (e.target !== del) this.classList.toggle('selected');
                });
                del.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm(`删除号码 ${span.dataset.number} ？`)) {
                        const idx = currentResults.indexOf(span.dataset.number);
                        if (idx > -1) currentResults.splice(idx,1);
                        renderResults(currentResults);
                        updateStats();
                    }
                });
                container.appendChild(span);
                if ((idx+1) % 7 === 0) container.appendChild(document.createElement('br'));
            });
        }

        // ---------- 更新统计 ----------
        function updateStats() {
            document.getElementById('result-count').textContent = currentResults.length;
            document.getElementById('result-price').textContent = currentResults.length * 2;
        }

        // ---------- 计算交集（生成条件始终参与）----------
        document.getElementById('calculate-intersection').addEventListener('click', function() {
            // 1. 手动条件框
            const sets = [];
            document.querySelectorAll('textarea[id^="input"]').forEach(input => {
                const text = input.value.trim();
                if (text) {
                    const nums = text.split(/\s+/).filter(n => n.length===3);
                    if (nums.length) sets.push(new Set(nums));
                }
            });
            if (sets.length < 2) {
                alert('请至少填写两个条件框的号码');
                return;
            }

            // 2. 生成条件池（始终作为条件0）
            const pool = generateConditionPool();
            if (pool.length === 0) {
                alert('当前形态设置下没有生成任何号码，请至少勾选一种包含类型');
                return;
            }
            sets.unshift(new Set(pool)); // 插入最前面

            // 3. 计算交集
            let intersection = [...sets[0]];
            for (let i = 1; i < sets.length; i++) {
                intersection = intersection.filter(n => sets[i].has(n));
            }

            // 4. 定位筛选
            const posCond = getPositionConditions();
            if (Object.values(posCond).some(arr => arr.length)) {
                intersection = applyPositionFilter(intersection, posCond);
            }

            currentResults = intersection;
            renderResults(currentResults);
            updateStats();
        });

        // ---------- 复制结果 ----------
        document.getElementById('copy-results').addEventListener('click', function() {
            if (!currentResults.length) return alert('没有可复制的结果');
            let text = '';
            currentResults.forEach((n,i) => {
                text += n + ' ';
                if ((i+1)%7===0) text += '\n';
            });
            navigator.clipboard.writeText(text.trim()).then(() => alert('已复制到剪贴板'))
                .catch(() => {
                    const ta = document.createElement('textarea');
                    ta.value = text.trim();
                    document.body.appendChild(ta);
                    ta.select();
                    document.execCommand('copy');
                    document.body.removeChild(ta);
                    alert('已复制到剪贴板');
                });
        });

        // ---------- 导出文件 ----------
        document.getElementById('export-results').addEventListener('click', function() {
            if (!currentResults.length) return alert('没有可导出的结果');
            let resultText = '';
            currentResults.forEach((n,i) => {
                resultText += n + ' ';
                if ((i+1)%7===0) resultText += '\n';
            });
            const cond = getPositionConditions();
            let condStr = '';
            ['hundred','ten','unit'].forEach(p => {
                const select = cond[`${p}Select`];
                const kill = cond[`${p}Kill`];
                if (select.length) condStr += `${p==='hundred'?'百位':p==='ten'?'十位':'个位'}选号: ${select.join(' ')}\n`;
                if (kill.length) condStr += `${p==='hundred'?'百位':p==='ten'?'十位':'个位'}杀号: ${kill.join(' ')}\n`;
            });
            const content = `福彩3D交集计算结果\n生成时间: ${new Date().toLocaleString()}\n\n筛选条件:\n${condStr || '无'}\n交集结果 (${currentResults.length}注，总价${currentResults.length*2}元):\n${resultText.trim()}`;
            const blob = new Blob([content], {type:'text/plain'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `3D交集结果_${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        });

        // ---------- 删除选中号码 ----------
        document.getElementById('delete-selected').addEventListener('click', function() {
            const selected = document.querySelectorAll('.number-item.selected');
            if (!selected.length) return alert('请先选中要删除的号码');
            if (confirm(`确定删除选中的 ${selected.length} 个号码？`)) {
                const toDel = new Set(Array.from(selected).map(el => el.dataset.number));
                currentResults = currentResults.filter(n => !toDel.has(n));
                renderResults(currentResults);
                updateStats();
            }
        });

        // ---------- 初始化 ----------
        document.addEventListener('DOMContentLoaded', function() {
            initNumberSelectors();
            initInputCounters();
            // 结果区域初始显示居中文字
            const resultsDiv = document.getElementById('intersection-results');
            resultsDiv.innerHTML = '<div class="results-placeholder">等待计算结果...</div>';
        });
    </script>
</body>
</html>
